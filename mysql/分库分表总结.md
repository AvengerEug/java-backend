# 一、为什么要分库分表

* 随着业务体量的上升，数据库里的数据会持续增加，最终可能会出现单表查询比较慢的情况（**通常是分页查询的场景，翻到越后面的页数，查询越慢**）。**又或者，因为单库的连接数有限，如果请求量较大时，会出现链接不够的情况**。这个时候可以把业务隔开，每种业务对应一个库，那业务之间就不会互相影响了。
# 二、分库分表的几种类型

## 2.1、分库

### 2.1.1、垂直分库

* 什么叫垂直分库？一句话总结：**按业务划分库，业务之间不会互相影响**。eg：用户域是一个库、会员域是一个库、商品域是一个库，用户和商品之间不会互相影响。常见于分布式微服务系统。

  ![垂直分库示例图](.\垂直分库示例图.jpg)

* 优点：业务解耦

* 缺点：还是会局限于某个库的某个表的数据量

### 2.1.2、水平分库
* 什么叫水平分库？一句话总结：**单库的数据量太大，连接数有限，需要分多个库来提高性能**。通常水平分库下，库里的每张表的结构都是一样的，只是把数据分摊到其他库里去了。

  ![水平分库示例图](.\水平分库示意图.png)

* 优点：单表数据量减少，提升性能

* 缺点：数据扩容难度大，如果要新增一个库的话，需要修改路由规则，同时还需要将数据重刷（eg：之前两个库，会根据userId对2取余做操来决定数据要落到哪个库中去。如果现在变成3个库了，那之前在1库的数据很有可能会落到第二个库中去，因此，这里需要做数据重刷操作）

## 2.2、分表
### 2.2.1、垂直分表
* 一句话总结：**垂直分表就是将某些不常用的、存储信息比较大的字段放在另外一张表，减少了mysql内存加载数据的大小以及网络传输的**。

* eg：用户信息表，在用户登录业务中可能只会用到用户名称和密码，但是像收货地址、身份证、性别这种在登录业务中很少用，因此这里就可以把用户信息表分成user_base和user_info表。如果要更新用户的详情信息时，再操作user_info表。

* 示例：

  ![垂直分表示意图](.\垂直分表.jpg)

* 特点：
  * 每张表的结构是不一样的。比如user_base表和user_info表
  * 两张表至少有一列的字段和值是一样的
  * 两张表并起来就是当前业务的全量数据

### 2.2.2、水平分表

* 一句话总结：**一张表存储的数据量有限，需要用多张表来存储数据**。

* 示例

  ![水平分表示意图](.\水平分表.jpg)

* 特点：
  * 水平分表后的每张表数据结构一模一样
  * 多张表并起来就是全量数据

> 所谓的垂直和水平，就看表是怎么被切割的。垂直分表是将一行的数据，分别存在不同的表中。水平分表，是将不同行的数据存在不同的表中。

# 三、分库分表中间件

* 分库分表中间件通常分位两种类别：
  * **jdbc直连**：举例 shardingsphere、tddl
  * **代理**：举例 mycat、mysqlproxy
* 通常情况下，jdbc直连的方式扩展性比较高。

## 3.1、jdbc直连工作原理
* 远程mysql服务器是多台，java应用以jar包的方式依赖，在客户端做操作，根据分片规则决定请求到mysql的哪台服务器的哪个库里。

* 以shardingsphere为例，它的原理是：

  ![shardingsphare](.\shardingsphare.jpg)

## 3.2、proxy工作原理

* java应用和连mysql一样。直接链接到代理机器，由代理机器做后续的路由操作。